<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simple Metronome</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #222;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    h1 {
      margin-bottom: 20px;
    }

    button {
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
	  width: 10em;
	  height: 5em;
    }

    input[type="range"] {
      width: 80vw;
      margin-top: 20px;
    }

    .tempo-display {
      margin-top: 10px;
      font-size: 20px;
    }
	#container{
		display: flex;
		flex-direction: column;
		height: 50%;
		align-items: center;
		justify-content: center;
		gap: 3em;
	}
  </style>
</head>
<body>
	<div id="container">
	  <h1>Metronome</h1>
	  <button id="toggleButton">Start</button>
	  <input type="range" id="tempoSlider" min="40" max="200" value="100">
	  <div class="tempo-display">Tempo: <span id="tempoValue">100</span> BPM</div>
	</div>
<script>
  const toggleButton = document.getElementById('toggleButton');
  const tempoSlider = document.getElementById('tempoSlider');
  const tempoValue = document.getElementById('tempoValue');

  let bpm = parseInt(tempoSlider.value);
  let isRunning = false;

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let nextNoteTime = 0.0;
  let timerID = null;

  // Lookahead scheduler settings
  const lookahead = 25.0; // in ms
  const scheduleAheadTime = 0.1; // in seconds
  var idx=0;
  function playClick(time) {
	if(idx%4 == 0 || idx < 7 || idx == 9 ) {
		const osc = audioCtx.createOscillator();
		const envelope = audioCtx.createGain();

		osc.type = 'square';
		var soundValue;
		if(idx%4 == 0) {
		  soundValue = 500;
		  }else {
		  soundValue = 1000;
		}
		osc.frequency.setValueAtTime(soundValue, time);
		envelope.gain.setValueAtTime(1, time);
		envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

		osc.connect(envelope);
		envelope.connect(audioCtx.destination);

		osc.start(time);
		osc.stop(time + 0.05);
	}
	idx+=1;
  }

  function nextNote() {
    const secondsPerBeat = 60.0 / bpm;
    nextNoteTime += secondsPerBeat;
  }

  function scheduler() {
    while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
      playClick(nextNoteTime);
      nextNote();
    }
    timerID = setTimeout(scheduler, lookahead);
  }

  function startMetronome() {
    nextNoteTime = audioCtx.currentTime + 0.05;
    scheduler();
  }

  function stopMetronome() {
    clearTimeout(timerID);
    timerID = null;
  }

  toggleButton.addEventListener('click', () => {
    if (!isRunning) {
      startMetronome();
      toggleButton.textContent = 'Stop';
      isRunning = true;
    } else {
      stopMetronome();
      toggleButton.textContent = 'Start';
      isRunning = false;
    }
  });

  tempoSlider.addEventListener('input', () => {
    bpm = parseInt(tempoSlider.value);
    tempoValue.textContent = bpm;

    if (isRunning) {
      stopMetronome();
      startMetronome();
    }
  });

  // Keyboard shortcut for spacebar
  document.addEventListener('keydown', (event) => {
    if (event.code === 'Space') {
      event.preventDefault();
      toggleButton.click();
    }
  });
</script>
</body>
</html>
